<!DOCTYPE html>
<html>
<head>
    <title>Test Patient Report</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 20px; background: #f5f5f5; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #fff; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .status { padding: 10px; border-radius: 4px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Patient Report System Test</h1>
        
        <div class="section">
            <h2>Step 1: Login Simulation</h2>
            <p>This will set the case_id in localStorage and redirect to patient page</p>
            <button onclick="simulateLogin()">Simulate Login (Case ID: 28)</button>
            <div id="loginStatus"></div>
        </div>

        <div class="section">
            <h2>Step 2: Check localStorage</h2>
            <button onclick="checkLocalStorage()">Check localStorage</button>
            <div id="storageStatus"></div>
        </div>

        <div class="section">
            <h2>Step 3: Fetch Report Data</h2>
            <button onclick="fetchReport()">Fetch Report from API</button>
            <div id="reportStatus"></div>
        </div>

        <div class="section">
            <h2>Step 4: View Formatted Report</h2>
            <button onclick="goToPatientPage()">Go to Patient Dashboard</button>
            <p><small>This will open the patient dashboard with case_id 28 logged in</small></p>
        </div>

        <div class="section">
            <h2>Debug Information</h2>
            <pre id="debugInfo">Loading...</pre>
        </div>
    </div>

    <script>
        function simulateLogin() {
            const caseId = 28;
            const phone = "01016828734";
            
            const statusDiv = document.getElementById('loginStatus');
            statusDiv.innerHTML = '<div class="status">Sending login request...</div>';
            
            fetch('http://127.0.0.1:8000/api/v1/patient/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Id: String(caseId), Name: phone })
            })
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    localStorage.setItem('patient_case_id', data.case_id);
                    statusDiv.innerHTML = `<div class="status success">✓ Login successful! Case ID stored: ${data.case_id}</div>`;
                    console.log('Login response:', data);
                } else {
                    statusDiv.innerHTML = `<div class="status error">✗ Login failed: ${data.message}</div>`;
                }
            })
            .catch(e => {
                statusDiv.innerHTML = `<div class="status error">✗ Error: ${e.message}</div>`;
            });
        }

        function checkLocalStorage() {
            const statusDiv = document.getElementById('storageStatus');
            const caseId = localStorage.getItem('patient_case_id');
            
            if (caseId) {
                statusDiv.innerHTML = `<div class="status success">✓ Case ID found in localStorage: <strong>${caseId}</strong></div>`;
            } else {
                statusDiv.innerHTML = `<div class="status error">✗ No case ID in localStorage. Please login first.</div>`;
            }
        }

        function fetchReport() {
            const caseId = localStorage.getItem('patient_case_id');
            if (!caseId) {
                document.getElementById('reportStatus').innerHTML = `<div class="status error">✗ No case ID found. Please login first.</div>`;
                return;
            }

            const statusDiv = document.getElementById('reportStatus');
            statusDiv.innerHTML = '<div class="status">Fetching report...</div>';
            
            fetch(`http://127.0.0.1:8000/api/v1/patient/report/${caseId}`)
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    statusDiv.innerHTML = `<div class="status success">✓ Report fetched successfully!</div>`;
                    statusDiv.innerHTML += `<pre>${JSON.stringify(data.data, null, 2)}</pre>`;
                    console.log('Report data:', data.data);
                } else {
                    statusDiv.innerHTML = `<div class="status error">✗ Failed to fetch report: ${data.message}</div>`;
                }
            })
            .catch(e => {
                statusDiv.innerHTML = `<div class="status error">✗ Error: ${e.message}</div>`;
            });
        }

        function goToPatientPage() {
            const caseId = localStorage.getItem('patient_case_id');
            if (!caseId) {
                alert('Please click "Simulate Login" first to set the case ID');
                return;
            }
            window.location.href = '/patient';
        }

        function updateDebugInfo() {
            const caseId = localStorage.getItem('patient_case_id');
            document.getElementById('debugInfo').textContent = JSON.stringify({
                timestamp: new Date().toISOString(),
                localStorage: {
                    patient_case_id: caseId || 'NOT SET'
                },
                location: {
                    href: window.location.href,
                    pathname: window.location.pathname
                },
                browser: {
                    userAgent: navigator.userAgent
                }
            }, null, 2);
        }

        // Update debug info on load and every 2 seconds
        updateDebugInfo();
        setInterval(updateDebugInfo, 2000);
    </script>
</body>
</html>
